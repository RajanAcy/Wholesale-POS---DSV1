<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wholesale POS - Internal System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
            min-height: 100vh;
        }

        .active-tab {
            background-color: #4f46e5;
            color: white;
        }

        .product-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 15px 3px rgba(0, 0, 0, 0.1);
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #c5c5c5;
            border-radius: 10px;
        }

        .receipt-card {
            border: 2px dashed #9ca3af;
            border-radius: 0.5rem;
            padding: 1rem;
            background-color: #f9fafb;
        }

        @media print {
            body * {
                visibility: hidden;
            }

            .receipt,
            .receipt * {
                visibility: visible;
            }

            .receipt {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                padding: 1rem;
            }
        }
    </style>
</head>

<body class="bg-gray-100 flex items-center justify-center p-4">
    <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-7xl mx-auto flex flex-col md:flex-row space-y-6 md:space-y-0 md:space-x-6">

        <!-- Sidebar Navigation -->
        <div class="flex-none w-full md:w-64 bg-gray-50 rounded-lg p-4 shadow-inner">
            <h1 class="text-2xl font-bold text-gray-800 mb-6">Wholesale POS</h1>
            <nav class="space-y-2">
                <button id="dashboardTab" class="w-full flex items-center p-3 text-sm font-medium rounded-lg hover:bg-gray-200 transition-colors duration-200 active-tab">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 mr-3">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 13.5a9.5 9.5 0 0115.3-7.5l-3.2 3.2m-12 0l3.2-3.2m-3.2 3.2a9.5 9.5 0 0115.3 7.5l-3.2-3.2M7.2 12.8a.8.8 0 100-1.6.8.8 0 000 1.6z" />
                    </svg>
                    Dashboard
                </button>
                <button id="productsTab" class="w-full flex items-center p-3 text-sm font-medium rounded-lg hover:bg-gray-200 transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 mr-3">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                    </svg>
                    Products
                </button>
                <button id="salesTab" class="w-full flex items-center p-3 text-sm font-medium rounded-lg hover:bg-gray-200 transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 mr-3">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 10.5h.007m-7.5 0h.007m7.5 0a.75.75 0 110 1.5.75.75 0 010-1.5zM12 12.75a.75.75 0 110 1.5.75.75 0 010-1.5zM4.5 18a.75.75 0 110 1.5.75.75 0 010-1.5z" />
                    </svg>
                    Sales
                </button>
                <button id="suppliersTab" class="w-full flex items-center p-3 text-sm font-medium rounded-lg hover:bg-gray-200 transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 mr-3">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4m18-6H3l9-9m0 18v-12" />
                    </svg>
                    Suppliers
                </button>
                <button id="customersTab" class="w-full flex items-center p-3 text-sm font-medium rounded-lg hover:bg-gray-200 transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-3">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 9h-2.25a.75.75 0 000 1.5H15V9z" />
                        <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 9h2.25a.75.75 0 000 1.5H8.25V9z" />
                        <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 15h2.25a.75.75 0 000 1.5H8.25V15z" />
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12.75 15h2.25a.75.75 0 000 1.5H12.75V15z" />
                        <path stroke-linecap="round" stroke-linejoin="round" d="M21 21L15 15" />
                        <path stroke-linecap="round" stroke-linejoin="round" d="M21 21h-6v-6" />
                    </svg>
                    Customers
                </button>
                <button id="reportsTab" class="w-full flex items-center p-3 text-sm font-medium rounded-lg hover:bg-gray-200 transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 mr-3">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M10 20.5v-10h4v10M10 14.5v-4h4v4M10 18.5v-4h4v4" />
                    </svg>
                    Reports
                </button>
                <button id="settingsTab" class="w-full flex items-center p-3 text-sm font-medium rounded-lg hover:bg-gray-200 transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 mr-3">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 6a6 6 0 100 12 6 6 0 000-12z" />
                    </svg>
                    Settings
                </button>
            </nav>
        </div>

        <!-- Main Content Area -->
        <main class="flex-grow w-full md:w-auto bg-gray-50 rounded-lg p-6 shadow-inner relative overflow-y-auto max-h-[80vh]">

            <!-- Dashboard View -->
            <div id="dashboardView" class="view">
                <h2 class="text-3xl font-bold text-gray-900 mb-6">Dashboard</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white rounded-lg p-6 shadow-md transition-all duration-300 transform hover:scale-105">
                        <h3 class="text-sm font-medium text-gray-500">Total Sales</h3>
                        <p class="text-3xl font-bold text-gray-900 mt-2" id="totalSales">0 MMK</p>
                    </div>
                    <div class="bg-white rounded-lg p-6 shadow-md transition-all duration-300 transform hover:scale-105">
                        <h3 class="text-sm font-medium text-gray-500">Total Profit</h3>
                        <p class="text-3xl font-bold text-gray-900 mt-2" id="totalProfit">0 MMK</p>
                    </div>
                    <div class="bg-white rounded-lg p-6 shadow-md transition-all duration-300 transform hover:scale-105">
                        <h3 class="text-sm font-medium text-gray-500">Total Products</h3>
                        <p class="text-3xl font-bold text-gray-900 mt-2" id="totalProducts">0</p>
                    </div>
                    <div class="bg-white rounded-lg p-6 shadow-md transition-all duration-300 transform hover:scale-105">
                        <h3 class="text-sm font-medium text-gray-500">Credit Payments</h3>
                        <p class="text-3xl font-bold text-red-500 mt-2" id="totalCreditPayments">0 MMK</p>
                    </div>
                </div>

                <!-- Charts Section -->
                <div class="bg-white rounded-lg p-6 shadow-md mb-8">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Sales Trends (Last 7 Days)</h3>
                    <canvas id="salesChart"></canvas>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white rounded-lg p-6 shadow-md">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Top 5 Best-Selling Products</h3>
                        <canvas id="bestSellingProductsChart"></canvas>
                    </div>
                    <div class="bg-white rounded-lg p-6 shadow-md">
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Sales by Category</h3>
                        <canvas id="salesByCategoryChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Products View -->
            <div id="productsView" class="view hidden">
                <h2 class="text-3xl font-bold text-gray-900 mb-6">Product Management</h2>
                <div class="bg-white rounded-lg p-6 shadow-md mb-6">
                    <form id="productForm" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <input type="hidden" id="productId">
                        <div class="flex flex-col">
                            <label for="productName" class="text-sm font-medium text-gray-700 mb-1">Product Name</label>
                            <input type="text" id="productName" required class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div class="flex flex-col">
                            <label for="productImage" class="text-sm font-medium text-gray-700 mb-1">Product Image</label>
                            <input type="file" id="productImage" accept="image/*" class="p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div class="flex flex-col">
                            <label for="productCategory" class="text-sm font-medium text-gray-700 mb-1">Category</label>
                            <input type="text" id="productCategory" required class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div class="flex flex-col">
                            <label for="productStock" class="text-sm font-medium text-gray-700 mb-1">Stock</label>
                            <input type="number" id="productStock" required class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div class="flex flex-col">
                            <label for="productBuyingPrice" class="text-sm font-medium text-gray-700 mb-1">Buying Price (MMK)</label>
                            <input type="number" id="productBuyingPrice" required class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div class="flex flex-col">
                            <label for="productSellingPrice" class="text-sm font-medium text-gray-700 mb-1">Selling Price (MMK)</label>
                            <input type="number" id="productSellingPrice" required class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div class="flex flex-col">
                            <label for="productSupplier" class="text-sm font-medium text-gray-700 mb-1">Supplier</label>
                            <select id="productSupplier" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                <option value="">Select a supplier</option>
                            </select>
                        </div>
                        <div class="flex flex-col">
                            <label for="productBarcode" class="text-sm font-medium text-gray-700 mb-1">Barcode</label>
                            <input type="text" id="productBarcode" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div class="flex items-end col-span-1 md:col-span-2 lg:col-span-3 space-x-4">
                            <button type="submit" class="bg-indigo-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-indigo-700 transition-colors duration-200">Save Product</button>
                            <button type="button" id="productClearBtn" class="bg-gray-300 text-gray-800 font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-gray-400 transition-colors duration-200">Clear Form</button>
                        </div>
                    </form>
                </div>
                
                <div class="bg-white rounded-lg p-6 shadow-md">
                    <div class="flex flex-col md:flex-row items-center justify-between mb-4 space-y-4 md:space-y-0">
                        <h3 class="text-xl font-semibold text-gray-800">Product List</h3>
                        <div class="flex space-x-2 w-full md:w-auto">
                            <input type="text" id="productSearch" placeholder="Search products..." class="w-full md:w-64 p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <button id="productSearchButton" class="bg-indigo-500 text-white p-2 rounded-lg hover:bg-indigo-600 transition-colors duration-200">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div class="mb-4 flex flex-wrap gap-2">
                        <input type="text" id="productFilterSupplier" placeholder="Filter by supplier..." class="p-2 border border-gray-300 rounded-lg">
                        <select id="productFilterStock" class="p-2 border border-gray-300 rounded-lg">
                            <option value="">All Stock</option>
                            <option value="inStock">In Stock</option>
                            <option value="outOfStock">Out of Stock</option>
                        </select>
                        <input type="number" id="productFilterMinPrice" placeholder="Min price..." class="p-2 border border-gray-300 rounded-lg">
                        <input type="number" id="productFilterMaxPrice" placeholder="Max price..." class="p-2 border border-gray-300 rounded-lg">
                    </div>
                    <div id="productList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 custom-scrollbar overflow-y-auto max-h-[50vh] pr-2">
                        <!-- Product cards will be rendered here -->
                    </div>
                </div>
            </div>

            <!-- Sales View -->
            <div id="salesView" class="view hidden">
                <h2 class="text-3xl font-bold text-gray-900 mb-6">Sales</h2>
                <div class="flex flex-col lg:flex-row lg:space-x-6 space-y-6 lg:space-y-0">
                    <!-- POS Panel -->
                    <div class="bg-white rounded-lg p-6 shadow-md lg:w-2/3">
                        <div class="flex flex-col md:flex-row items-center justify-between mb-4 space-y-4 md:space-y-0">
                            <h3 class="text-xl font-semibold text-gray-800">POS</h3>
                            <div class="flex space-x-2 w-full md:w-auto">
                                <input type="text" id="salesSearch" placeholder="Search products..." class="w-full md:w-64 p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                <button id="salesSearchButton" class="bg-indigo-500 text-white p-2 rounded-lg hover:bg-indigo-600 transition-colors duration-200">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div id="salesProductList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4 custom-scrollbar overflow-y-auto max-h-[50vh] pr-2">
                            <!-- Product cards for sales will be rendered here -->
                        </div>
                    </div>

                    <!-- Cart and Payment Panel -->
                    <div class="bg-white rounded-lg p-6 shadow-md lg:w-1/3 flex flex-col">
                        <h3 class="text-xl font-semibold text-gray-800 mb-4">Cart</h3>
                        <div id="cartList" class="flex-grow space-y-4 custom-scrollbar overflow-y-auto max-h-[40vh] pr-2">
                            <!-- Cart items will be rendered here -->
                            <p id="emptyCartMessage" class="text-gray-500 text-center">Your cart is empty.</p>
                        </div>
                        <div class="mt-4 border-t pt-4">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-lg font-medium text-gray-700">Subtotal:</span>
                                <span class="text-lg font-bold text-gray-900" id="subtotal">0 MMK</span>
                            </div>
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-lg font-medium text-gray-700">Discount:</span>
                                <input type="number" id="discountPercentage" placeholder="%" class="w-20 p-1 border rounded text-center">
                                <span class="text-lg font-bold text-gray-900" id="discountAmount">0 MMK</span>
                            </div>
                            <div class="flex justify-between items-center mb-4">
                                <span class="text-xl font-semibold text-gray-800">Total:</span>
                                <span class="text-2xl font-bold text-indigo-600" id="total">0 MMK</span>
                            </div>
                            <form id="paymentForm">
                                <div class="mb-4">
                                    <label for="paymentMethod" class="block text-sm font-medium text-gray-700 mb-1">Payment Method</label>
                                    <select id="paymentMethod" required class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                        <option value="Cash">Cash</option>
                                        <option value="Credit">Credit</option>
                                        <option value="Mobile Payment Transfer">Mobile Payment Transfer</option>
                                        <option value="Bank Transfer">Bank Transfer</option>
                                    </select>
                                </div>
                                <div class="mb-4">
                                    <label for="customerType" class="block text-sm font-medium text-gray-700 mb-1">Customer Type</label>
                                    <select id="customerType" required class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                        <option value="Walk-in Customer">Walk-in Customer</option>
                                        <option value="Online Customer">Online Customer</option>
                                    </select>
                                </div>
                                <button type="submit" class="w-full bg-indigo-600 text-white font-semibold py-3 rounded-lg shadow-md hover:bg-indigo-700 transition-colors duration-200">
                                    Complete Sale
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Suppliers View -->
            <div id="suppliersView" class="view hidden">
                <h2 class="text-3xl font-bold text-gray-900 mb-6">Supplier Management</h2>
                <div class="bg-white rounded-lg p-6 shadow-md mb-6">
                    <form id="supplierForm" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <input type="hidden" id="supplierId">
                        <div class="flex flex-col">
                            <label for="supplierName" class="text-sm font-medium text-gray-700 mb-1">Supplier Name</label>
                            <input type="text" id="supplierName" required class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div class="flex flex-col">
                            <label for="supplierPhone" class="text-sm font-medium text-gray-700 mb-1">Phone Number</label>
                            <input type="tel" id="supplierPhone" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div class="flex flex-col">
                            <label for="supplierAddress" class="text-sm font-medium text-gray-700 mb-1">Address</label>
                            <input type="text" id="supplierAddress" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div class="flex flex-col">
                            <label for="supplierPaymentTerms" class="text-sm font-medium text-gray-700 mb-1">Payment Terms</label>
                            <input type="text" id="supplierPaymentTerms" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div class="flex flex-col">
                            <label for="supplierTaxID" class="text-sm font-medium text-gray-700 mb-1">Tax ID</label>
                            <input type="text" id="supplierTaxID" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div class="flex flex-col">
                            <label for="supplierBankDetails" class="text-sm font-medium text-gray-700 mb-1">Bank Details</label>
                            <input type="text" id="supplierBankDetails" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div class="flex items-end col-span-1 md:col-span-2 space-x-4">
                            <button type="submit" class="bg-indigo-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-indigo-700 transition-colors duration-200">Save Supplier</button>
                            <button type="button" id="supplierClearBtn" class="bg-gray-300 text-gray-800 font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-gray-400 transition-colors duration-200">Clear Form</button>
                        </div>
                    </form>
                </div>
                <div class="bg-white rounded-lg p-6 shadow-md">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-semibold text-gray-800">Supplier List</h3>
                        <div class="flex space-x-2">
                            <input type="text" id="supplierSearch" placeholder="Search suppliers..." class="w-64 p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <button id="supplierSearchButton" class="bg-indigo-500 text-white p-2 rounded-lg hover:bg-indigo-600 transition-colors duration-200">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Phone Number</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Balance</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="supplierTableBody" class="bg-white divide-y divide-gray-200">
                                <!-- Supplier rows will be rendered here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Customers View -->
            <div id="customersView" class="view hidden">
                <h2 class="text-3xl font-bold text-gray-900 mb-6">Customer Management</h2>
                <div class="bg-white rounded-lg p-6 shadow-md mb-6">
                    <form id="customerForm" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <input type="hidden" id="customerId">
                        <div class="flex flex-col">
                            <label for="customerName" class="text-sm font-medium text-gray-700 mb-1">Customer Name</label>
                            <input type="text" id="customerName" required class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div class="flex flex-col">
                            <label for="customerPhone" class="text-sm font-medium text-gray-700 mb-1">Phone Number</label>
                            <input type="tel" id="customerPhone" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div class="flex flex-col">
                            <label for="customerCity" class="text-sm font-medium text-gray-700 mb-1">City/Township</label>
                            <input type="text" id="customerCity" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div class="flex flex-col">
                            <label for="customerSpecialty" class="text-sm font-medium text-gray-700 mb-1">Product Specialty Tag</label>
                            <input type="text" id="customerSpecialty" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div class="flex items-end col-span-1 md:col-span-2 space-x-4">
                            <button type="submit" class="bg-indigo-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-indigo-700 transition-colors duration-200">Save Customer</button>
                            <button type="button" id="customerClearBtn" class="bg-gray-300 text-gray-800 font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-gray-400 transition-colors duration-200">Clear Form</button>
                        </div>
                    </form>
                </div>
                <div class="bg-white rounded-lg p-6 shadow-md">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-semibold text-gray-800">Customer List</h3>
                        <div class="flex space-x-2">
                            <input type="text" id="customerSearch" placeholder="Search customers..." class="w-64 p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <button id="customerSearchButton" class="bg-indigo-500 text-white p-2 rounded-lg hover:bg-indigo-600 transition-colors duration-200">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Phone Number</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">City/Township</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Specialty</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="customerTableBody" class="bg-white divide-y divide-gray-200">
                                <!-- Customer rows will be rendered here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Reports View -->
            <div id="reportsView" class="view hidden">
                <h2 class="text-3xl font-bold text-gray-900 mb-6">Reports</h2>
                <div class="bg-white rounded-lg p-6 shadow-md mb-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-semibold text-gray-800">Sales Report</h3>
                    </div>
                    <div class="flex flex-col md:flex-row items-center space-y-4 md:space-y-0 md:space-x-4 mb-4">
                        <div class="w-full md:w-1/2">
                            <label for="reportDateStart" class="block text-sm font-medium text-gray-700">Start Date</label>
                            <input type="date" id="reportDateStart" class="w-full p-2 border border-gray-300 rounded-lg">
                        </div>
                        <div class="w-full md:w-1/2">
                            <label for="reportDateEnd" class="block text-sm font-medium text-gray-700">End Date</label>
                            <input type="date" id="reportDateEnd" class="w-full p-2 border border-gray-300 rounded-lg">
                        </div>
                        <button id="generateReportBtn" class="w-full md:w-auto bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-indigo-700 transition-colors duration-200 mt-4 md:mt-0">Generate Report</button>
                    </div>
                    <div id="reportContent" class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Product</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Quantity</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Price (MMK)</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total (MMK)</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Profit (MMK)</th>
                                </tr>
                            </thead>
                            <tbody id="reportTableBody" class="bg-white divide-y divide-gray-200">
                                <!-- Report rows will be rendered here -->
                            </tbody>
                        </table>
                        <div class="mt-4 text-right">
                            <p class="text-lg font-semibold text-gray-800">Total Profit: <span id="reportTotalProfit" class="text-indigo-600">0 MMK</span></p>
                        </div>
                    </div>
                    <div class="mt-4 flex justify-end">
                        <button id="exportReportBtn" class="bg-green-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-green-700 transition-colors duration-200">Export to CSV</button>
                    </div>
                </div>
            </div>
            
            <!-- Settings View -->
            <div id="settingsView" class="view hidden">
                <h2 class="text-3xl font-bold text-gray-900 mb-6">Settings</h2>
                <div class="bg-white rounded-lg p-6 shadow-md mb-6">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">Company Details</h3>
                    <form id="companySettingsForm">
                        <div class="mb-4">
                            <label for="companyName" class="block text-sm font-medium text-gray-700 mb-1">Company Name</label>
                            <input type="text" id="companyName" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div class="mb-4">
                            <label for="companyLogo" class="block text-sm font-medium text-gray-700 mb-1">Company Logo</label>
                            <input type="file" id="companyLogo" accept="image/*" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <p class="text-sm text-gray-500 mt-1">Accepted formats: .jpg, .png</p>
                        </div>
                        <button type="submit" class="bg-indigo-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-indigo-700 transition-colors duration-200">Save Settings</button>
                    </form>
                </div>
                
                <div class="bg-white rounded-lg p-6 shadow-md">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">Data Storage</h3>
                    <p class="text-gray-600 mb-4">Choose where to store your application data locally. Please refresh the app after changing this setting for it to take effect.</p>
                    <form id="storageSettingsForm">
                        <div class="mb-4">
                            <div class="flex items-center mb-2">
                                <input type="radio" id="storageLocalStorage" name="storageType" value="localStorage" class="h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500">
                                <label for="storageLocalStorage" class="ml-3 block text-sm font-medium text-gray-700">Local Storage</label>
                            </div>
                            <div class="flex items-center mb-2">
                                <input type="radio" id="storageIndexedDB" name="storageType" value="indexedDB" class="h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500">
                                <label for="storageIndexedDB" class="ml-3 block text-sm font-medium text-gray-700">IndexedDB</label>
                            </div>
                            <div class="flex items-center mb-2">
                                <input type="radio" id="storageCustomPath" name="storageType" value="customPath" class="h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500">
                                <label for="storageCustomPath" class="ml-3 block text-sm font-medium text-gray-700">Custom Path</label>
                            </div>
                        </div>
                        <div id="customPathContainer" class="mb-4 hidden">
                            <label for="storagePath" class="block text-sm font-medium text-gray-700 mb-1">Storage Folder Path</label>
                            <div class="flex">
                                <input type="text" id="storagePath" class="flex-grow p-2 border border-gray-300 rounded-l-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="C:/POSData">
                                <button type="button" id="browseButton" class="bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-r-lg hover:bg-gray-400 transition-colors duration-200">Browse</button>
                            </div>
                        </div>
                        <button type="submit" class="bg-indigo-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-indigo-700 transition-colors duration-200">Save Storage Settings</button>
                    </form>
                </div>
                
                <div class="bg-white rounded-lg p-6 shadow-md mt-6">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">Data Management</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <button id="exportDataBtn" class="bg-green-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-green-700 transition-colors duration-200">Export All Data</button>
                        <button id="importDataBtn" class="bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-blue-700 transition-colors duration-200">Import Data</button>
                        <input type="file" id="importDataInput" accept=".json" class="hidden">
                        <button id="clearDataBtn" class="bg-red-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-red-700 transition-colors duration-200 md:col-span-2">Clear All Data</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="receiptModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full hidden flex items-center justify-center p-4">
        <div class="relative bg-white rounded-lg p-6 shadow-lg max-w-sm w-full">
            <h3 class="text-lg font-bold text-gray-900 mb-4">Receipt</h3>
            <div id="receiptContent" class="receipt text-sm">
                <!-- Receipt content will be rendered here -->
            </div>
            <div class="mt-6 flex justify-end space-x-2">
                <button id="printReceiptBtn" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-indigo-700 transition-colors duration-200">Print</button>
                <button id="closeReceiptBtn" class="bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-gray-400 transition-colors duration-200">Close</button>
            </div>
        </div>
    </div>
    
    <div id="paymentModal" class="fixed inset-0 bg-gray-600 bg-opacity-75 overflow-y-auto h-full w-full hidden flex items-center justify-center p-4">
        <div class="relative bg-white rounded-xl p-6 shadow-lg max-w-lg w-full">
            <h3 class="text-lg font-bold text-gray-900 mb-4">Record Payment to <span id="paymentSupplierName"></span></h3>
            <form id="paymentFormSupplier">
                <input type="hidden" id="paymentSupplierId">
                <div class="mb-4">
                    <label for="paymentAmount" class="block text-sm font-medium text-gray-700 mb-1">Amount (MMK)</label>
                    <input type="number" id="paymentAmount" required class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                <div class="mb-4">
                    <label for="paymentDate" class="block text-sm font-medium text-gray-700 mb-1">Date</label>
                    <input type="date" id="paymentDate" required class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                <div class="mb-4">
                    <label for="paymentNotes" class="block text-sm font-medium text-gray-700 mb-1">Notes</label>
                    <textarea id="paymentNotes" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"></textarea>
                </div>
                <div class="flex justify-end space-x-2">
                    <button type="button" id="closePaymentModalBtn" class="bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-gray-400 transition-colors duration-200">Cancel</button>
                    <button type="submit" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-indigo-700 transition-colors duration-200">Record Payment</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-5 right-5 bg-green-500 text-white py-3 px-6 rounded-lg shadow-xl hidden transition-opacity duration-300 opacity-0">
        Item added to cart!
    </div>

    <script>
        // Data Store
        const store = {
            products: [],
            suppliers: [],
            customers: [],
            sales: [],
            supplierPayments: [],
            company: {
                name: 'Your Company',
                logo: null
            },
            storageType: localStorage.getItem('storageType') || 'localStorage',
            cart: [] // Initialize cart array
        };

        let elements = {};
        const DB_NAME = 'wholesalePosDB';
        const DB_VERSION = 1;

        // --- Data Storage Service ---
        const storageService = {
            db: null,
            async initIndexedDB() {
                return new Promise((resolve, reject) => {
                    if (this.db) {
                        return resolve(this.db);
                    }
                    const request = indexedDB.open(DB_NAME, DB_VERSION);
                    request.onupgradeneeded = (event) => {
                        this.db = event.target.result;
                        if (!this.db.objectStoreNames.contains('products')) {
                            this.db.createObjectStore('products', { keyPath: 'id' });
                        }
                        if (!this.db.objectStoreNames.contains('suppliers')) {
                            this.db.createObjectStore('suppliers', { keyPath: 'id' });
                        }
                        if (!this.db.objectStoreNames.contains('customers')) {
                            this.db.createObjectStore('customers', { keyPath: 'id' });
                        }
                        if (!this.db.objectStoreNames.contains('sales')) {
                            this.db.createObjectStore('sales', { keyPath: 'id' });
                        }
                        if (!this.db.objectStoreNames.contains('supplierPayments')) {
                            this.db.createObjectStore('supplierPayments', { keyPath: 'id' });
                        }
                        if (!this.db.objectStoreNames.contains('company')) {
                            this.db.createObjectStore('company', { keyPath: 'id' });
                        }
                    };
                    request.onsuccess = (event) => {
                        this.db = event.target.result;
                        resolve(this.db);
                    };
                    request.onerror = (event) => {
                        console.error('IndexedDB error:', event.target.error);
                        reject(event.target.error);
                    };
                });
            },

            async saveData(storeName, data) {
                if (store.storageType === 'localStorage') {
                    localStorage.setItem(storeName, JSON.stringify(data));
                } else if (store.storageType === 'indexedDB') {
                    await this.initIndexedDB();
                    const tx = this.db.transaction(storeName, 'readwrite');
                    const objStore = tx.objectStore(storeName);
                    if (Array.isArray(data)) {
                        await objStore.clear();
                        data.forEach(item => objStore.put(item));
                    } else {
                        await objStore.put({ ...data, id: storeName });
                    }
                    return tx.complete;
                }
            },

            async loadData(storeName) {
                if (store.storageType === 'localStorage') {
                    const data = localStorage.getItem(storeName);
                    return data ? JSON.parse(data) : (storeName === 'company' ? { name: 'Your Company', logo: null } : []);
                } else if (store.storageType === 'indexedDB') {
                    await this.initIndexedDB();
                    const tx = this.db.transaction(storeName, 'readonly');
                    const objStore = tx.objectStore(storeName);
                    const request = objStore.getAll();
                    return new Promise((resolve) => {
                        request.onsuccess = () => {
                            resolve(request.result);
                        };
                    });
                }
            },

            async saveAll() {
                await this.saveData('products', store.products);
                await this.saveData('suppliers', store.suppliers);
                await this.saveData('customers', store.customers);
                await this.saveData('sales', store.sales);
                await this.saveData('supplierPayments', store.supplierPayments);
                await this.saveData('company', store.company);
            },

            async loadAll() {
                store.products = await this.loadData('products') || [];
                store.suppliers = await this.loadData('suppliers') || [];
                store.customers = await this.loadData('customers') || [];
                store.sales = await this.loadData('sales') || [];
                store.supplierPayments = await this.loadData('supplierPayments') || [];
                const companyData = await this.loadData('company');
                if (companyData && companyData.length > 0) {
                     store.company = companyData[0];
                }
            }
        };

        const saveStore = async () => {
            await storageService.saveAll();
        };

        const navigateTo = (viewName) => {
            if (!elements.views || !elements.views[viewName] || !elements.tabButtons || !elements.tabButtons[`${viewName}Tab`]) {
                console.error(`Attempted to navigate to a non-existent view: ${viewName}`);
                return;
            }
            
            Object.values(elements.views).forEach(view => view.classList.add('hidden'));
            elements.views[viewName].classList.remove('hidden');
            Object.values(elements.tabButtons).forEach(btn => btn.classList.remove('active-tab'));
            elements.tabButtons[`${viewName}Tab`].classList.add('active-tab');

            // Specific view updates
            if (viewName === 'dashboard') {
                renderDashboard();
            } else if (viewName === 'products') {
                renderProducts();
            } else if (viewName === 'sales') {
                renderSalesProducts();
                updateCartUI();
            } else if (viewName === 'suppliers') {
                renderSuppliers();
            } else if (viewName === 'customers') {
                renderCustomers();
            } else if (viewName === 'reports') {
                renderReports();
            } else if (viewName === 'settings') {
                renderSettings();
            }
        };

        const showToast = (message) => {
            elements.toast.textContent = message;
            elements.toast.classList.remove('hidden', 'opacity-0');
            elements.toast.classList.add('opacity-100');
            setTimeout(() => {
                elements.toast.classList.remove('opacity-100');
                elements.toast.classList.add('opacity-0');
                setTimeout(() => {
                    elements.toast.classList.add('hidden');
                }, 300);
            }, 2000);
        };

        // --- Dashboard Functions ---
        let salesChart, bestSellingProductsChart, salesByCategoryChart;

        const renderDashboard = () => {
            const totalSales = store.sales.reduce((sum, sale) => sum + sale.total, 0);
            const totalProfit = store.sales.reduce((sum, sale) => sum + sale.profit, 0);
            const totalCredit = store.sales.filter(s => s.paymentMethod === 'Credit').reduce((sum, sale) => sum + sale.total, 0);

            elements.dashboard.totalSales.textContent = `${totalSales.toFixed(2)} MMK`;
            elements.dashboard.totalProfit.textContent = `${totalProfit.toFixed(2)} MMK`;
            elements.dashboard.totalProducts.textContent = store.products.length;
            elements.dashboard.totalCreditPayments.textContent = `${totalCredit.toFixed(2)} MMK`;

            // Sales Chart
            const salesData = {};
            const today = new Date();
            for (let i = 6; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(today.getDate() - i);
                salesData[date.toISOString().split('T')[0]] = 0;
            }
            store.sales.forEach(sale => {
                const date = new Date(sale.date).toISOString().split('T')[0];
                if (salesData[date] !== undefined) {
                    salesData[date] += sale.total;
                }
            });

            if (salesChart) salesChart.destroy();
            salesChart = new Chart(elements.dashboard.salesChart, {
                type: 'line',
                data: {
                    labels: Object.keys(salesData),
                    datasets: [{
                        label: 'Sales (MMK)',
                        data: Object.values(salesData),
                        borderColor: '#4f46e5',
                        backgroundColor: 'rgba(79, 70, 229, 0.2)',
                        fill: true,
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });

            // Best-Selling Products Chart
            const productSales = {};
            store.sales.forEach(sale => {
                sale.items.forEach(item => {
                    productSales[item.name] = (productSales[item.name] || 0) + item.quantity;
                });
            });
            const sortedProducts = Object.entries(productSales).sort(([, a], [, b]) => b - a).slice(0, 5);

            if (bestSellingProductsChart) bestSellingProductsChart.destroy();
            bestSellingProductsChart = new Chart(elements.dashboard.bestSellingProductsChart, {
                type: 'bar',
                data: {
                    labels: sortedProducts.map(([name]) => name),
                    datasets: [{
                        label: 'Quantity Sold',
                        data: sortedProducts.map(([, qty]) => qty),
                        backgroundColor: '#4f46e5'
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
            
            // Sales by Category Chart
            const salesByCategory = {};
            store.sales.forEach(sale => {
                sale.items.forEach(item => {
                    salesByCategory[item.category] = (salesByCategory[item.category] || 0) + item.totalPrice;
                });
            });

            if (salesByCategoryChart) salesByCategoryChart.destroy();
            salesByCategoryChart = new Chart(elements.dashboard.salesByCategoryChart, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(salesByCategory),
                    datasets: [{
                        label: 'Sales by Category',
                        data: Object.values(salesByCategory),
                        backgroundColor: [
                            '#4f46e5', '#8b5cf6', '#d8b4fe', '#f87171', '#fcd34d'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                }
            });
        };

        // --- Products Functions ---
        const renderProducts = (searchTerm = '', supplierFilter = '', stockFilter = '', minPrice = null, maxPrice = null) => {
            const list = elements.product.list;
            list.innerHTML = '';
            
            const filteredProducts = store.products.filter(p => {
                const matchesSearch = p.name.toLowerCase().includes(searchTerm.toLowerCase());
                const matchesSupplier = supplierFilter === '' || p.supplierId === supplierFilter;
                const matchesStock = stockFilter === '' ||
                    (stockFilter === 'inStock' && p.stock > 0) ||
                    (stockFilter === 'outOfStock' && p.stock <= 0);
                const matchesMinPrice = minPrice === null || p.sellingPrice >= minPrice;
                const matchesMaxPrice = maxPrice === null || p.sellingPrice <= maxPrice;
                return matchesSearch && matchesSupplier && matchesStock && matchesMinPrice && matchesMaxPrice;
            });

            if (filteredProducts.length === 0) {
                list.innerHTML = '<p class="text-gray-500 text-center col-span-full">No products found.</p>';
            }

            filteredProducts.forEach(product => {
                const margin = ((product.sellingPrice - product.buyingPrice) / product.sellingPrice) * 100;
                const supplier = store.suppliers.find(s => s.id === product.supplierId)?.name || 'N/A';
                const card = `
                    <div class="bg-white rounded-lg shadow-md p-4 product-card transition-all duration-300">
                        <img src="${product.image || 'https://placehold.co/100x100/e2e8f0/4a5568?text=Product'}" alt="${product.name}" class="w-full h-32 object-contain rounded-lg mb-2">
                        <h4 class="text-lg font-semibold text-gray-800 truncate">${product.name}</h4>
                        <p class="text-gray-600 text-sm">Category: ${product.category}</p>
                        <p class="text-gray-600 text-sm">Supplier: ${supplier}</p>
                        <p class="text-gray-600 text-sm">Stock: <span class="${product.stock > 0 ? 'text-green-600' : 'text-red-600'} font-bold">${product.stock}</span></p>
                        <p class="text-gray-600 text-sm">Price: <span class="font-bold">${product.sellingPrice.toFixed(2)} MMK</span></p>
                        <p class="text-gray-600 text-sm">Margin: <span class="font-bold">${margin.toFixed(2)}%</span></p>
                        <div class="flex space-x-2 mt-4">
                            <button onclick="editProduct('${product.id}')" class="flex-1 bg-indigo-500 text-white text-sm py-2 rounded-lg hover:bg-indigo-600 transition-colors duration-200">Edit</button>
                            <button onclick="deleteProduct('${product.id}')" class="flex-1 bg-red-500 text-white text-sm py-2 rounded-lg hover:bg-red-600 transition-colors duration-200">Delete</button>
                        </div>
                    </div>
                `;
                list.innerHTML += card;
            });
            renderSupplierSelect();
        };

        const handleProductFormSubmit = async (e) => {
            e.preventDefault();
            const id = elements.product.id.value;
            const file = elements.product.image.files[0];
            let imageUrl = '';

            const saveProduct = async (imgUrl) => {
                const newProduct = {
                    id: id || Date.now().toString(),
                    name: elements.product.name.value,
                    image: imgUrl,
                    category: elements.product.category.value,
                    stock: parseInt(elements.product.stock.value),
                    buyingPrice: parseFloat(elements.product.buyingPrice.value),
                    sellingPrice: parseFloat(elements.product.sellingPrice.value),
                    supplierId: elements.product.supplier.value || null,
                    barcode: elements.product.barcode.value || null
                };

                const supplier = store.suppliers.find(s => s.id === newProduct.supplierId);
                if (supplier) {
                    const existingProduct = store.products.find(p => p.id === id);
                    const oldStock = existingProduct ? existingProduct.stock : 0;
                    const stockChange = newProduct.stock - oldStock;
                    const costChange = stockChange * newProduct.buyingPrice;
                    supplier.totalPurchases = (supplier.totalPurchases || 0) + costChange;
                }

                if (id) {
                    const index = store.products.findIndex(p => p.id === id);
                    if (index !== -1) {
                        store.products[index] = { ...store.products[index], ...newProduct };
                    }
                } else {
                    store.products.push(newProduct);
                }
                await saveStore();
                clearProductForm();
                renderProducts();
            };

            if (file) {
                const reader = new FileReader();
                reader.onloadend = () => {
                    saveProduct(reader.result);
                };
                reader.readAsDataURL(file);
            } else {
                const existingProduct = store.products.find(p => p.id === id);
                await saveProduct(existingProduct ? existingProduct.image : null);
            }
        };

        const editProduct = (id) => {
            navigateTo('products');
            const product = store.products.find(p => p.id === id);
            if (product) {
                elements.product.id.value = product.id;
                elements.product.name.value = product.name;
                elements.product.category.value = product.category;
                elements.product.stock.value = product.stock;
                elements.product.buyingPrice.value = product.buyingPrice;
                elements.product.sellingPrice.value = product.sellingPrice;
                elements.product.supplier.value = product.supplierId || '';
                elements.product.barcode.value = product.barcode || '';
            }
        };

        const deleteProduct = async (id) => {
            const product = store.products.find(p => p.id === id);
            if (!confirm('Are you sure you want to delete this product?')) return;
            
            if (product && product.supplierId) {
                const supplier = store.suppliers.find(s => s.id === product.supplierId);
                if (supplier) {
                    supplier.totalPurchases = (supplier.totalPurchases || 0) - (product.stock * product.buyingPrice);
                }
            }

            store.products = store.products.filter(p => p.id !== id);
            await saveStore();
            renderProducts();
        };

        const clearProductForm = () => {
            elements.product.form.reset();
            elements.product.id.value = '';
            elements.product.image.value = '';
        };

        const renderSupplierSelect = () => {
            const select = elements.product.supplier;
            select.innerHTML = '<option value="">Select a supplier</option>';
            store.suppliers.forEach(supplier => {
                const option = document.createElement('option');
                option.value = supplier.id;
                option.textContent = supplier.name;
                select.appendChild(option);
            });
            const filterSelect = elements.product.filterSupplier;
            if (filterSelect) {
                filterSelect.innerHTML = '<option value="">All Suppliers</option>';
                store.suppliers.forEach(supplier => {
                    const option = document.createElement('option');
                    option.value = supplier.id;
                    option.textContent = supplier.name;
                    filterSelect.appendChild(option);
                });
            }
        };

        // --- Sales Functions ---
        const renderSalesProducts = (searchTerm = '') => {
            const list = elements.sales.productList;
            list.innerHTML = '';
            const filteredProducts = store.products.filter(p => p.name.toLowerCase().includes(searchTerm.toLowerCase()));

            if (filteredProducts.length === 0) {
                list.innerHTML = '<p class="text-gray-500 text-center col-span-full">No products found.</p>';
            }

            filteredProducts.forEach(product => {
                const card = `
                    <div class="bg-white rounded-lg shadow-md p-4 product-card transition-all duration-300 cursor-pointer" onclick="addToCart('${product.id}')">
                        <img src="${product.image || 'https://placehold.co/100x100/e2e8f0/4a5568?text=Product'}" alt="${product.name}" class="w-full h-32 object-contain rounded-lg mb-2">
                        <h4 class="text-lg font-semibold text-gray-800 truncate">${product.name}</h4>
                        <p class="text-gray-600 text-sm">Stock: <span class="${product.stock > 0 ? 'text-green-600' : 'text-red-600'} font-bold">${product.stock}</span></p>
                        <p class="text-gray-600 text-sm">Price: <span class="font-bold">${product.sellingPrice.toFixed(2)} MMK</span></p>
                    </div>
                `;
                list.innerHTML += card;
            });
        };

        const addToCart = (productId) => {
            const product = store.products.find(p => p.id === productId);
            if (!product || product.stock <= 0) {
                showToast('Product is out of stock!');
                return;
            }

            const existingCartItem = store.cart.find(item => item.id === productId);
            if (existingCartItem) {
                existingCartItem.quantity++;
            } else {
                store.cart.push({
                    id: product.id,
                    name: product.name,
                    category: product.category,
                    price: product.sellingPrice,
                    buyingPrice: product.buyingPrice,
                    quantity: 1
                });
            }
            showToast('Item added to cart!');
            updateCartUI();
        };

        const removeFromCart = (productId) => {
            const index = store.cart.findIndex(item => item.id === productId);
            if (index !== -1) {
                store.cart.splice(index, 1);
                updateCartUI();
            }
        };

        const updateCartItemQuantity = (productId, newQuantity) => {
            const item = store.cart.find(item => item.id === productId);
            const product = store.products.find(p => p.id === productId);
            if (item && product) {
                if (newQuantity > product.stock) {
                    showToast('Cannot add more than available stock!');
                    newQuantity = product.stock;
                }
                item.quantity = Math.max(0, newQuantity);
                if (item.quantity === 0) {
                    removeFromCart(productId);
                } else {
                    updateCartUI();
                }
            }
        };

        const updateCartUI = () => {
            const list = elements.sales.cartList;
            list.innerHTML = '';
            let subtotal = 0;

            if (store.cart.length === 0) {
                elements.sales.emptyCartMessage.classList.remove('hidden');
            } else {
                elements.sales.emptyCartMessage.classList.add('hidden');
                store.cart.forEach(item => {
                    const itemTotal = item.price * item.quantity;
                    subtotal += itemTotal;
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'bg-gray-50 rounded-lg p-3 flex items-center justify-between shadow-sm';
                    itemDiv.innerHTML = `
                        <div>
                            <p class="font-semibold text-gray-800">${item.name}</p>
                            <p class="text-sm text-gray-600">${item.price.toFixed(2)} MMK x ${item.quantity}</p>
                        </div>
                        <div class="flex items-center space-x-2">
                            <input type="number" value="${item.quantity}" min="1" class="w-16 text-center border rounded-lg p-1" onchange="updateCartItemQuantity('${item.id}', parseInt(this.value))">
                            <span class="font-bold">${itemTotal.toFixed(2)} MMK</span>
                            <button onclick="removeFromCart('${item.id}')" class="text-red-500 hover:text-red-700">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                        </div>
                    `;
                    list.appendChild(itemDiv);
                });
            }
            
            elements.sales.subtotal.textContent = `${subtotal.toFixed(2)} MMK`;
            
            const discountPercent = parseFloat(elements.sales.discountPercentage.value) || 0;
            const discountAmount = subtotal * (discountPercent / 100);
            const total = subtotal - discountAmount;
            
            elements.sales.discountAmount.textContent = `${discountAmount.toFixed(2)} MMK`;
            elements.sales.total.textContent = `${total.toFixed(2)} MMK`;
        };
        
        const handlePaymentFormSubmit = async (e) => {
            e.preventDefault();
            if (store.cart.length === 0) {
                alert('Cart is empty!');
                return;
            }

            const sale = {
                id: Date.now().toString(),
                date: new Date().toISOString(),
                items: store.cart.map(item => ({
                    id: item.id,
                    name: item.name,
                    category: item.category,
                    quantity: item.quantity,
                    price: item.price,
                    buyingPrice: item.buyingPrice,
                    totalPrice: item.price * item.quantity,
                    profit: (item.price - item.buyingPrice) * item.quantity
                })),
                subtotal: parseFloat(elements.sales.subtotal.textContent),
                discount: parseFloat(elements.sales.discountAmount.textContent),
                total: parseFloat(elements.sales.total.textContent),
                paymentMethod: elements.sales.paymentMethod.value,
                customerType: elements.sales.customerType.value,
                profit: store.cart.reduce((sum, item) => sum + (item.price - item.buyingPrice) * item.quantity, 0)
            };
            store.sales.push(sale);

            // Update product stock
            sale.items.forEach(item => {
                const product = store.products.find(p => p.id === item.id);
                if (product) {
                    product.stock -= item.quantity;
                }
            });

            await saveStore();
            generateReceipt(sale);
            store.cart = [];
            updateCartUI();
            renderSalesProducts();
            showToast('Sale completed!');
        };
        
        const generateReceipt = (sale) => {
            const content = elements.receiptContent;
            content.innerHTML = '';
            
            const companyInfo = store.company;
            const logo = companyInfo.logo ? `<img src="${companyInfo.logo}" alt="Company Logo" class="w-24 h-24 mx-auto mb-2">` : '';
            const companyName = companyInfo.name || 'Your Company';
            
            content.innerHTML = `
                <div class="receipt-card space-y-2">
                    <div class="text-center">
                        ${logo}
                        <h4 class="text-xl font-bold">${companyName}</h4>
                        <p class="text-xs text-gray-500">Sales Receipt</p>
                        <p class="text-xs text-gray-500 mt-1">Customer Type: ${sale.customerType}</p>
                    </div>
                    <hr class="border-t border-gray-300 my-2">
                    <div class="flex justify-between text-xs">
                        <span>Date:</span>
                        <span>${new Date(sale.date).toLocaleString()}</span>
                    </div>
                    <div class="flex justify-between text-xs mb-2">
                        <span>Sale ID:</span>
                        <span>${sale.id}</span>
                    </div>
                    <hr class="border-t border-gray-300 my-2">
                    <div class="font-bold text-xs">
                        <div class="flex justify-between">
                            <span>Item</span>
                            <span>Qty</span>
                            <span>Price</span>
                            <span>Total</span>
                        </div>
                    </div>
                    <hr class="border-t border-gray-300 my-2">
                    ${sale.items.map(item => `
                        <div class="flex justify-between text-sm">
                            <span class="w-1/2">${item.name}</span>
                            <span class="w-1/6 text-center">${item.quantity}</span>
                            <span class="w-1/6 text-right">${item.price.toFixed(2)}</span>
                            <span class="w-1/6 text-right">${item.totalPrice.toFixed(2)}</span>
                        </div>
                    `).join('')}
                    <hr class="border-t border-gray-300 my-2">
                    <div class="space-y-1 text-sm">
                        <div class="flex justify-between">
                            <span class="font-semibold">Subtotal:</span>
                            <span class="font-bold">${sale.subtotal.toFixed(2)} MMK</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="font-semibold">Discount:</span>
                            <span class="font-bold">-${sale.discount.toFixed(2)} MMK</span>
                        </div>
                        <div class="flex justify-between font-bold text-lg">
                            <span>Total:</span>
                            <span>${sale.total.toFixed(2)} MMK</span>
                        </div>
                    </div>
                    <div class="flex justify-between text-sm mt-2">
                        <span>Payment Method:</span>
                        <span>${sale.paymentMethod}</span>
                    </div>
                    <div class="text-center mt-4">
                        <p class="text-xs text-gray-500">Thank you for your business!</p>
                    </div>
                </div>
            `;
            elements.receiptModal.classList.remove('hidden');
        };

        // --- Suppliers Functions ---
        const renderSuppliers = (searchTerm = '') => {
            const tbody = elements.supplier.tableBody;
            tbody.innerHTML = '';
            const filteredSuppliers = store.suppliers.filter(s => s.name.toLowerCase().includes(searchTerm.toLowerCase()));

            if (filteredSuppliers.length === 0) {
                tbody.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-gray-500">No suppliers found.</td></tr>`;
            }

            filteredSuppliers.forEach(supplier => {
                const totalPaid = store.supplierPayments
                    .filter(p => p.supplierId === supplier.id)
                    .reduce((sum, payment) => sum + payment.amount, 0);
                const balance = (supplier.totalPurchases || 0) - totalPaid;
                const balanceClass = balance > 0 ? 'text-red-500 font-bold' : 'text-green-500 font-bold';

                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-100 transition-colors duration-200';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${supplier.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${supplier.phone || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm ${balanceClass}">${balance.toFixed(2)} MMK</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button onclick="recordPayment('${supplier.id}', '${supplier.name}')" class="text-green-600 hover:text-green-900 mr-4">Record Payment</button>
                        <button onclick="editSupplier('${supplier.id}')" class="text-indigo-600 hover:text-indigo-900 mr-4">Edit</button>
                        <button onclick="deleteSupplier('${supplier.id}')" class="text-red-600 hover:text-red-900">Delete</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        };

        const handleSupplierFormSubmit = async (e) => {
            e.preventDefault();
            const id = elements.supplier.id.value;
            const newSupplier = {
                id: id || Date.now().toString(),
                name: elements.supplier.name.value,
                phone: elements.supplier.phone.value,
                address: elements.supplier.address.value,
                paymentTerms: elements.supplier.paymentTerms.value,
                taxID: elements.supplier.taxID.value,
                bankDetails: elements.supplier.bankDetails.value,
                totalPurchases: id ? (store.suppliers.find(s => s.id === id)?.totalPurchases || 0) : 0
            };

            if (id) {
                const index = store.suppliers.findIndex(s => s.id === id);
                if (index !== -1) {
                    store.suppliers[index] = { ...store.suppliers[index], ...newSupplier };
                }
            } else {
                store.suppliers.push(newSupplier);
            }
            await saveStore();
            clearSupplierForm();
            renderSuppliers();
            renderSupplierSelect();
        };

        const editSupplier = (id) => {
            navigateTo('suppliers');
            const supplier = store.suppliers.find(s => s.id === id);
            if (supplier) {
                elements.supplier.id.value = supplier.id;
                elements.supplier.name.value = supplier.name;
                elements.supplier.phone.value = supplier.phone || '';
                elements.supplier.address.value = supplier.address || '';
                elements.supplier.paymentTerms.value = supplier.paymentTerms || '';
                elements.supplier.taxID.value = supplier.taxID || '';
                elements.supplier.bankDetails.value = supplier.bankDetails || '';
            }
        };

        const deleteSupplier = async (id) => {
            if (confirm('Are you sure you want to delete this supplier? This will also remove associated products and payments.')) {
                store.products = store.products.filter(p => p.supplierId !== id);
                store.supplierPayments = store.supplierPayments.filter(p => p.supplierId !== id);
                store.suppliers = store.suppliers.filter(s => s.id !== id);
                await saveStore();
                renderSuppliers();
                renderSupplierSelect();
                renderProducts();
            }
        };

        const clearSupplierForm = () => {
            elements.supplier.form.reset();
            elements.supplier.id.value = '';
        };
        
        const recordPayment = (id, name) => {
            elements.payment.supplierId.value = id;
            elements.payment.supplierName.textContent = name;
            elements.payment.date.value = new Date().toISOString().split('T')[0];
            elements.paymentModal.classList.remove('hidden');
        };

        const handleSupplierPaymentFormSubmit = async (e) => {
            e.preventDefault();
            const payment = {
                id: Date.now().toString(),
                supplierId: elements.payment.supplierId.value,
                amount: parseFloat(elements.payment.amount.value),
                date: elements.payment.date.value,
                notes: elements.payment.notes.value,
            };

            if (payment.amount > 0) {
                store.supplierPayments.push(payment);
                await saveStore();
                showToast('Payment recorded successfully!');
                elements.payment.form.reset();
                elements.paymentModal.classList.add('hidden');
                renderSuppliers();
            } else {
                alert('Please enter a positive payment amount.');
            }
        };

        // --- Customers Functions ---
        const renderCustomers = (searchTerm = '') => {
            const tbody = elements.customer.tableBody;
            tbody.innerHTML = '';
            const filteredCustomers = store.customers.filter(c => c.name.toLowerCase().includes(searchTerm.toLowerCase()));

            if (filteredCustomers.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-gray-500">No customers found.</td></tr>`;
            }

            filteredCustomers.forEach(customer => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-100 transition-colors duration-200';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${customer.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${customer.phone || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${customer.city || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${customer.specialty || 'N/A'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button onclick="editCustomer('${customer.id}')" class="text-indigo-600 hover:text-indigo-900 mr-4">Edit</button>
                        <button onclick="deleteCustomer('${customer.id}')" class="text-red-600 hover:text-red-900">Delete</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        };

        const handleCustomerFormSubmit = async (e) => {
            e.preventDefault();
            const id = elements.customer.id.value;
            const newCustomer = {
                id: id || Date.now().toString(),
                name: elements.customer.name.value,
                phone: elements.customer.phone.value,
                city: elements.customer.city.value,
                specialty: elements.customer.specialty.value,
            };

            if (id) {
                const index = store.customers.findIndex(c => c.id === id);
                if (index !== -1) {
                    store.customers[index] = newCustomer;
                }
            } else {
                store.customers.push(newCustomer);
            }
            await saveStore();
            clearCustomerForm();
            renderCustomers();
        };

        const editCustomer = (id) => {
            navigateTo('customers');
            const customer = store.customers.find(c => c.id === id);
            if (customer) {
                elements.customer.id.value = customer.id;
                elements.customer.name.value = customer.name;
                elements.customer.phone.value = customer.phone || '';
                elements.customer.city.value = customer.city || '';
                elements.customer.specialty.value = customer.specialty || '';
            }
        };

        const deleteCustomer = async (id) => {
            if (confirm('Are you sure you want to delete this customer?')) {
                store.customers = store.customers.filter(c => c.id !== id);
                await saveStore();
                renderCustomers();
            }
        };

        const clearCustomerForm = () => {
            elements.customer.form.reset();
            elements.customer.id.value = '';
        };


        // --- Reports Functions ---
        const renderReports = (startDate = null, endDate = null) => {
            const tbody = elements.reports.tableBody;
            tbody.innerHTML = '';
            let totalProfit = 0;

            const filteredSales = store.sales.filter(sale => {
                const saleDate = new Date(sale.date);
                const isAfterStart = !startDate || saleDate >= new Date(startDate);
                const isBeforeEnd = !endDate || saleDate <= new Date(endDate);
                return isAfterStart && isBeforeEnd;
            });

            if (filteredSales.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" class="text-center py-4 text-gray-500">No sales data for this period.</td></tr>`;
            }

            filteredSales.forEach(sale => {
                sale.items.forEach(item => {
                    totalProfit += item.profit;
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-100 transition-colors duration-200';
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${new Date(sale.date).toLocaleDateString()}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${item.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.quantity}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.price.toFixed(2)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.totalPrice.toFixed(2)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-green-600 font-semibold">${item.profit.toFixed(2)}</td>
                    `;
                    tbody.appendChild(row);
                });
            });

            elements.reports.totalProfit.textContent = `${totalProfit.toFixed(2)} MMK`;
        };

        // --- Settings Functions ---
        const renderSettings = () => {
            elements.settings.name.value = store.company.name;
            const currentStorage = localStorage.getItem('storageType') || 'localStorage';
            elements.settings.storageForm.querySelector(`input[value="${currentStorage}"]`).checked = true;
            
            // Show/hide custom path container based on selection
            if (currentStorage === 'customPath') {
                elements.settings.customPathContainer.classList.remove('hidden');
            } else {
                elements.settings.customPathContainer.classList.add('hidden');
            }
        };

        const handleCompanySettingsFormSubmit = async (e) => {
            e.preventDefault();
            const file = elements.settings.logo.files[0];

            const saveSettings = async (imgUrl) => {
                store.company.name = elements.settings.name.value;
                if (imgUrl) {
                    store.company.logo = imgUrl;
                }
                await saveStore();
                showToast('Settings saved successfully!');
            };

            if (file) {
                const reader = new FileReader();
                reader.onloadend = () => {
                    saveSettings(reader.result);
                };
                reader.readAsDataURL(file);
            } else {
                await saveSettings(null);
            }
        };
        
        const handleStorageSettingsFormSubmit = (e) => {
            e.preventDefault();
            const selectedStorage = elements.settings.storageForm.querySelector('input[name="storageType"]:checked').value;
            localStorage.setItem('storageType', selectedStorage);
            
            if (selectedStorage === 'customPath') {
                const storagePath = elements.settings.storagePath.value;
                if (storagePath) {
                    localStorage.setItem('storagePath', storagePath);
                    showToast('Storage path saved. Please reload the app.');
                } else {
                    showToast('Please enter a valid storage path.');
                }
            } else {
                showToast('Storage setting saved. Please reload the app.');
            }
        };

        // --- Data Export/Import Functions ---
        const exportAllData = () => {
            const data = {
                products: store.products,
                suppliers: store.suppliers,
                customers: store.customers,
                sales: store.sales,
                supplierPayments: store.supplierPayments,
                company: store.company
            };
            
            const dataStr = JSON.stringify(data, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = 'pos-data.json';
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        };

        const importData = (file) => {
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if (data.products) store.products = data.products;
                    if (data.suppliers) store.suppliers = data.suppliers;
                    if (data.customers) store.customers = data.customers;
                    if (data.sales) store.sales = data.sales;
                    if (data.supplierPayments) store.supplierPayments = data.supplierPayments;
                    if (data.company) store.company = data.company;
                    
                    await saveStore();
                    showToast('Data imported successfully!');
                    navigateTo('dashboard');
                } catch (error) {
                    console.error('Error importing data:', error);
                    showToast('Error importing data. Please check the file format.');
                }
            };
            reader.readAsText(file);
        };

        const clearAllData = () => {
            if (confirm('Are you sure you want to clear all data? This action cannot be undone.')) {
                store.products = [];
                store.suppliers = [];
                store.customers = [];
                store.sales = [];
                store.supplierPayments = [];
                store.company = { name: 'Your Company', logo: null };
                store.cart = [];
                
                localStorage.clear();
                indexedDB.deleteDatabase(DB_NAME);
                
                showToast('All data cleared successfully!');
                navigateTo('dashboard');
            }
        };

        // --- Export Report to CSV ---
        const exportReportToCSV = () => {
            const startDate = elements.reports.dateStart.value;
            const endDate = elements.reports.dateEnd.value;
            
            const filteredSales = store.sales.filter(sale => {
                const saleDate = new Date(sale.date);
                const isAfterStart = !startDate || saleDate >= new Date(startDate);
                const isBeforeEnd = !endDate || saleDate <= new Date(endDate);
                return isAfterStart && isBeforeEnd;
            });
            
            let csvContent = "Date,Product,Quantity,Price,Total,Profit\n";
            
            filteredSales.forEach(sale => {
                sale.items.forEach(item => {
                    csvContent += `"${new Date(sale.date).toLocaleDateString()}","${item.name}",${item.quantity},${item.price},${item.totalPrice},${item.profit}\n`;
                });
            });
            
            const encodedUri = encodeURI("data:text/csv;charset=utf-8," + csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `sales-report-${startDate || 'all'}-to-${endDate || 'all'}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        window.onload = async () => {
            // Initialize the elements object here, when the DOM is ready
            elements = {
                views: {
                    dashboard: document.getElementById('dashboardView'),
                    products: document.getElementById('productsView'),
                    sales: document.getElementById('salesView'),
                    suppliers: document.getElementById('suppliersView'),
                    customers: document.getElementById('customersView'),
                    reports: document.getElementById('reportsView'),
                    settings: document.getElementById('settingsView')
                },
                tabButtons: {
                    dashboardTab: document.getElementById('dashboardTab'),
                    productsTab: document.getElementById('productsTab'),
                    salesTab: document.getElementById('salesTab'),
                    suppliersTab: document.getElementById('suppliersTab'),
                    customersTab: document.getElementById('customersTab'),
                    reportsTab: document.getElementById('reportsTab'),
                    settingsTab: document.getElementById('settingsTab')
                },
                dashboard: {
                    totalSales: document.getElementById('totalSales'),
                    totalProfit: document.getElementById('totalProfit'),
                    totalProducts: document.getElementById('totalProducts'),
                    totalCreditPayments: document.getElementById('totalCreditPayments'),
                    salesChart: document.getElementById('salesChart'),
                    bestSellingProductsChart: document.getElementById('bestSellingProductsChart'),
                    salesByCategoryChart: document.getElementById('salesByCategoryChart')
                },
                product: {
                    form: document.getElementById('productForm'),
                    id: document.getElementById('productId'),
                    name: document.getElementById('productName'),
                    image: document.getElementById('productImage'),
                    category: document.getElementById('productCategory'),
                    stock: document.getElementById('productStock'),
                    buyingPrice: document.getElementById('productBuyingPrice'),
                    sellingPrice: document.getElementById('productSellingPrice'),
                    supplier: document.getElementById('productSupplier'),
                    barcode: document.getElementById('productBarcode'),
                    clearBtn: document.getElementById('productClearBtn'),
                    list: document.getElementById('productList'),
                    search: document.getElementById('productSearch'),
                    searchButton: document.getElementById('productSearchButton'),
                    filterSupplier: document.getElementById('productFilterSupplier'),
                    filterStock: document.getElementById('productFilterStock'),
                    filterMinPrice: document.getElementById('productFilterMinPrice'),
                    filterMaxPrice: document.getElementById('productFilterMaxPrice')
                },
                sales: {
                    search: document.getElementById('salesSearch'),
                    searchButton: document.getElementById('salesSearchButton'),
                    productList: document.getElementById('salesProductList'),
                    cartList: document.getElementById('cartList'),
                    emptyCartMessage: document.getElementById('emptyCartMessage'),
                    subtotal: document.getElementById('subtotal'),
                    discountPercentage: document.getElementById('discountPercentage'),
                    discountAmount: document.getElementById('discountAmount'),
                    total: document.getElementById('total'),
                    paymentForm: document.getElementById('paymentForm'),
                    paymentMethod: document.getElementById('paymentMethod'),
                    customerType: document.getElementById('customerType')
                },
                supplier: {
                    form: document.getElementById('supplierForm'),
                    id: document.getElementById('supplierId'),
                    name: document.getElementById('supplierName'),
                    phone: document.getElementById('supplierPhone'),
                    address: document.getElementById('supplierAddress'),
                    paymentTerms: document.getElementById('supplierPaymentTerms'),
                    taxID: document.getElementById('supplierTaxID'),
                    bankDetails: document.getElementById('supplierBankDetails'),
                    clearBtn: document.getElementById('supplierClearBtn'),
                    tableBody: document.getElementById('supplierTableBody'),
                    search: document.getElementById('supplierSearch'),
                    searchButton: document.getElementById('supplierSearchButton')
                },
                customer: {
                    form: document.getElementById('customerForm'),
                    id: document.getElementById('customerId'),
                    name: document.getElementById('customerName'),
                    phone: document.getElementById('customerPhone'),
                    city: document.getElementById('customerCity'),
                    specialty: document.getElementById('customerSpecialty'),
                    clearBtn: document.getElementById('customerClearBtn'),
                    tableBody: document.getElementById('customerTableBody'),
                    search: document.getElementById('customerSearch'),
                    searchButton: document.getElementById('customerSearchButton')
                },
                reports: {
                    dateStart: document.getElementById('reportDateStart'),
                    dateEnd: document.getElementById('reportDateEnd'),
                    generateBtn: document.getElementById('generateReportBtn'),
                    tableBody: document.getElementById('reportTableBody'),
                    totalProfit: document.getElementById('reportTotalProfit')
                },
                settings: {
                    companyForm: document.getElementById('companySettingsForm'),
                    name: document.getElementById('companyName'),
                    logo: document.getElementById('companyLogo'),
                    storageForm: document.getElementById('storageSettingsForm'),
                    customPathContainer: document.getElementById('customPathContainer'),
                    storagePath: document.getElementById('storagePath')
                },
                receiptModal: document.getElementById('receiptModal'),
                receiptContent: document.getElementById('receiptContent'),
                printReceiptBtn: document.getElementById('printReceiptBtn'),
                closeReceiptBtn: document.getElementById('closeReceiptBtn'),
                paymentModal: document.getElementById('paymentModal'),
                payment: {
                    form: document.getElementById('paymentFormSupplier'),
                    supplierId: document.getElementById('paymentSupplierId'),
                    supplierName: document.getElementById('paymentSupplierName'),
                    amount: document.getElementById('paymentAmount'),
                    date: document.getElementById('paymentDate'),
                    notes: document.getElementById('paymentNotes')
                },
                closePaymentModalBtn: document.getElementById('closePaymentModalBtn'),
                toast: document.getElementById('toast')
            };

            // Load data before setting up event listeners
            await storageService.loadAll();
            
            // --- Event Listeners ---
            elements.tabButtons.dashboardTab.addEventListener('click', () => navigateTo('dashboard'));
            elements.tabButtons.productsTab.addEventListener('click', () => navigateTo('products'));
            elements.tabButtons.salesTab.addEventListener('click', () => navigateTo('sales'));
            elements.tabButtons.suppliersTab.addEventListener('click', () => navigateTo('suppliers'));
            elements.tabButtons.customersTab.addEventListener('click', () => navigateTo('customers'));
            elements.tabButtons.reportsTab.addEventListener('click', () => navigateTo('reports'));
            elements.tabButtons.settingsTab.addEventListener('click', () => navigateTo('settings'));

            elements.product.form.addEventListener('submit', handleProductFormSubmit);
            elements.product.clearBtn.addEventListener('click', clearProductForm);
            elements.product.searchButton.addEventListener('click', () => renderProducts(elements.product.search.value));
            elements.product.search.addEventListener('keyup', (e) => { if (e.key === 'Enter') renderProducts(elements.product.search.value); });
            if (elements.product.filterSupplier) {
                elements.product.filterSupplier.addEventListener('change', () => renderProducts(elements.product.search.value, elements.product.filterSupplier.value));
            }
            if (elements.product.filterStock) {
                elements.product.filterStock.addEventListener('change', () => renderProducts(elements.product.search.value, elements.product.filterSupplier.value, elements.product.filterStock.value));
            }
            if (elements.product.filterMinPrice) {
                elements.product.filterMinPrice.addEventListener('input', () => {
                    const minPrice = parseFloat(elements.product.filterMinPrice.value) || null;
                    const maxPrice = parseFloat(elements.product.filterMaxPrice.value) || null;
                    renderProducts(elements.product.search.value, elements.product.filterSupplier.value, elements.product.filterStock.value, minPrice, maxPrice);
                });
            }
            if (elements.product.filterMaxPrice) {
                elements.product.filterMaxPrice.addEventListener('input', () => {
                    const minPrice = parseFloat(elements.product.filterMinPrice.value) || null;
                    const maxPrice = parseFloat(elements.product.filterMaxPrice.value) || null;
                    renderProducts(elements.product.search.value, elements.product.filterSupplier.value, elements.product.filterStock.value, minPrice, maxPrice);
                });
            }

            elements.sales.searchButton.addEventListener('click', () => renderSalesProducts(elements.sales.search.value));
            elements.sales.search.addEventListener('keyup', (e) => { if (e.key === 'Enter') renderSalesProducts(elements.sales.search.value); });
            elements.sales.paymentForm.addEventListener('submit', handlePaymentFormSubmit);
            elements.sales.discountPercentage.addEventListener('input', updateCartUI);

            elements.supplier.form.addEventListener('submit', handleSupplierFormSubmit);
            elements.supplier.clearBtn.addEventListener('click', clearSupplierForm);
            elements.supplier.searchButton.addEventListener('click', () => renderSuppliers(elements.supplier.search.value));
            elements.supplier.search.addEventListener('keyup', (e) => { if (e.key === 'Enter') renderSuppliers(elements.supplier.search.value); });
            elements.payment.form.addEventListener('submit', handleSupplierPaymentFormSubmit);
            elements.closePaymentModalBtn.addEventListener('click', () => elements.paymentModal.classList.add('hidden'));

            elements.customer.form.addEventListener('submit', handleCustomerFormSubmit);
            elements.customer.clearBtn.addEventListener('click', clearCustomerForm);
            elements.customer.searchButton.addEventListener('click', () => renderCustomers(elements.customer.search.value));
            elements.customer.search.addEventListener('keyup', (e) => { if (e.key === 'Enter') renderCustomers(elements.customer.search.value); });


            elements.reports.generateBtn.addEventListener('click', () => {
                const startDate = elements.reports.dateStart.value;
                const endDate = elements.reports.dateEnd.value;
                renderReports(startDate, endDate);
            });

            // Export report button
            document.getElementById('exportReportBtn').addEventListener('click', exportReportToCSV);

            elements.settings.companyForm.addEventListener('submit', handleCompanySettingsFormSubmit);
            elements.settings.storageForm.addEventListener('submit', handleStorageSettingsFormSubmit);
            
            // Storage type change event
            elements.settings.storageForm.querySelectorAll('input[name="storageType"]').forEach(input => {
                input.addEventListener('change', (e) => {
                    if (e.target.value === 'customPath') {
                        elements.settings.customPathContainer.classList.remove('hidden');
                    } else {
                        elements.settings.customPathContainer.classList.add('hidden');
                    }
                });
            });

            // Browse button event
            document.getElementById('browseButton').addEventListener('click', () => {
                // Note: This is a simplified implementation
                // In a real app, you might use Electron or other desktop technologies for file system access
                const path = prompt('Enter the path where you want to store data:');
                if (path) {
                    elements.settings.storagePath.value = path;
                }
            });

            // Data management buttons
            document.getElementById('exportDataBtn').addEventListener('click', exportAllData);
            document.getElementById('importDataBtn').addEventListener('click', () => {
                document.getElementById('importDataInput').click();
            });
            document.getElementById('importDataInput').addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    importData(e.target.files[0]);
                }
            });
            document.getElementById('clearDataBtn').addEventListener('click', clearAllData);

            elements.closeReceiptBtn.addEventListener('click', () => {
                elements.receiptModal.classList.add('hidden');
            });
            
            elements.printReceiptBtn.addEventListener('click', () => {
                window.print();
            });
            
            navigateTo('dashboard');
            renderSupplierSelect();
        };

        // Global functions for inline HTML events
        window.editProduct = editProduct;
        window.deleteProduct = deleteProduct;
        window.addToCart = addToCart;
        window.removeFromCart = removeFromCart;
        window.updateCartItemQuantity = updateCartItemQuantity;
        window.editSupplier = editSupplier;
        window.deleteSupplier = deleteSupplier;
        window.recordPayment = recordPayment;
        window.editCustomer = editCustomer;
        window.deleteCustomer = deleteCustomer;
    </script>
</body>
</html>
